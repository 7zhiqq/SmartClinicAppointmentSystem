{% extends "components/base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/archive.css' %}">

{% if user.is_authenticated %}
    {% if user.role == "manager" %}
        {% include "components/sidebar/manager.html" %}
    {% else %}
        {% include "components/sidebar/staff.html" %}
    {% endif %}

    <div class="main-content">
        <div class="schedule-header mb-4">
            <div>
                <h2 class="heading-title">
                    <i class="bi bi-trash"></i> Deleted Records Audit Log
                </h2>
                <p class="subtitle">
                    View permanently deleted records for compliance and audit purposes
                </p>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="d-flex gap-2 mb-4">
            <form method="get" class="d-flex gap-2 flex-grow-1">
                <select name="model" class="form-select" style="max-width: 200px;">
                    <option value="">All Types</option>
                    {% for model in model_names %}
                        <option value="{{ model }}" {% if model == model_filter %}selected{% endif %}>
                            {{ model }}
                        </option>
                    {% endfor %}
                </select>

                <input
                    type="text"
                    name="search"
                    class="form-control"
                    placeholder="Search records..."
                    value="{{ search_query }}"
                >

                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> Search
                </button>

                {% if search_query or model_filter %}
                    <a href="{% url 'deleted_records' %}" class="btn btn-secondary">
                        <i class="bi bi-x"></i> Clear
                    </a>
                {% endif %}
            </form>
        </div>

        <!-- Stats -->
        <div class="archive-stats">
            <div class="archive-stat-card deleted">
                <div class="archive-stat-number">{{ deleted_records.count }}</div>
                <div class="archive-stat-label">Total Deleted Records</div>
            </div>
        </div>

        <!-- Deleted Records Table -->
        <div class="table-container">
            {% if deleted_records %}
                <table class="archive-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Record ID</th>
                            <th>Description</th>
                            <th>Deleted By</th>
                            <th>Deleted At</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in deleted_records %}
                            <tr>
                                <td>
                                    <span class="badge-deleted">
                                        {{ record.model_name }}
                                    </span>
                                </td>
                                <td>
                                    <code>{{ record.original_id }}</code>
                                </td>
                                <td>{{ record.object_repr }}</td>
                                <td>
                                    {% if record.deleted_by %}
                                        {{ record.deleted_by.get_full_name }}
                                    {% else %}
                                        System
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="archive-timeline-date">
                                        {{ record.deleted_at|date:"M d, Y" }}<br>
                                        <small>{{ record.deleted_at|time:"h:i A" }}</small>
                                    </div>
                                </td>
                                <td>
                                    <button
                                        type="button"
                                        class="btn btn-sm btn-secondary view-snapshot-btn"
                                        data-snapshot="{{ record.data_snapshot|escapejs }}"
                                    >
                                        <i class="bi bi-eye"></i> View Details
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="archive-empty-state">
                    <i class="bi bi-inbox"></i>
                    <h3>No Deleted Records</h3>
                    <p>No records have been permanently deleted yet.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Snapshot Modal -->
    <div class="modal fade" id="snapshotModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-file-code"></i> Record Snapshot
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <pre id="snapshotContent"
                         style="background:#f8f9fa;padding:16px;border-radius:8px;max-height:500px;overflow-y:auto;">
                    </pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Snapshot Viewer Script -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".view-snapshot-btn").forEach(button => {
                button.addEventListener("click", function () {
                    const snapshot = this.dataset.snapshot;

                    try {
                        const data = JSON.parse(snapshot);
                        document.getElementById("snapshotContent").textContent =
                            JSON.stringify(data, null, 2);

                        new bootstrap.Modal(
                            document.getElementById("snapshotModal")
                        ).show();
                    } catch (error) {
                        alert("Error displaying snapshot data");
                    }
                });
            });
        });
    </script>

{% endif %}
{% endblock %}
