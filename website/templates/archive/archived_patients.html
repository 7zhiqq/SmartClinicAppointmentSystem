{% extends "components/base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/medrecords.css' %}">
<link rel="stylesheet" href="{% static 'css/archive.css' %}">

{% if user.is_authenticated and user.role == "staff" %}
    {% include "components/sidebar/staff.html" %}
    
    <div class="main-content">
        <div class="schedule-header mb-4">
            <div>
                <h2 class="heading-title">
                    <i class="bi bi-archive"></i> Archived Patients
                </h2>
                <p class="subtitle">View archived patient records</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'patient_list' %}" class="add-schedule-btn">
                    <i class="bi bi-arrow-left"></i> Back to Patients
                </a>
            </div>
        </div>

        <!-- Stats -->
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="stat-card total">
                    <div class="stat-content">
                        <div class="stat-header">
                            <div>
                                <div class="stat-number">{{ all_patients|length }}</div>
                                <div class="stat-label">Total Archived Patients</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card confirmed">
                    <div class="stat-content">
                        <div class="stat-header">
                            <div>
                                <div class="stat-number">{{ archived_self.count }}</div>
                                <div class="stat-label">Self Patients</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card pending">
                    <div class="stat-content">
                        <div class="stat-header">
                            <div>
                                <div class="stat-number">{{ archived_dependents.count }}</div>
                                <div class="stat-label">Dependents</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard">
            <aside class="patient-list-panel">
                <input
                    type="text"
                    id="patientSearch"
                    class="search-input"
                    placeholder="Search patients..."
                >
                
                <ul class="patient-list">
                    {% for patient in all_patients %}
                        <li class="patient-item archived-item" 
                            data-patient-id="{{ patient.pk }}"
                            data-patient-type="{{ patient.patient_type }}"
                            onclick="loadArchivedPatient('{{ patient.pk }}', '{{ patient.patient_type }}')">
                            <div class="avatar">
                                {% if patient.patient_type == 'self' %}
                                    {{ patient.user_full_name|slice:":1" }}{{ patient.user_full_name|slice:"1:2" }}
                                {% else %}
                                    {{ patient.first_name|slice:":1" }}{{ patient.last_name|slice:":1" }}
                                {% endif %}
                            </div>
                            <div>
                                <strong>
                                    {% if patient.patient_type == 'self' %}
                                        {{ patient.user_full_name }}
                                    {% else %}
                                        {{ patient.first_name }} {{ patient.last_name }}
                                    {% endif %}
                                </strong>
                                <small>
                                    {{ patient.age }} yrs • 
                                    {% if patient.gender == 'M' %}Male{% else %}Female{% endif %}
                                    {% if patient.patient_type == 'dependent' %}
                                        • <span class="dependent-tag">Dependent</span>
                                    {% endif %}
                                </small>
                                <small class="archived-badge">
                                    <i class="bi bi-archive"></i> Archived {{ patient.archived_at|date:"M d, Y" }}
                                </small>
                            </div>
                        </li>
                    {% empty %}
                        <li><p class="muted">No archived patients.</p></li>
                    {% endfor %}
                </ul>
            </aside>

            <section class="patient-details" id="patientDetails">
                <p class="muted">Select an archived patient to view details...</p>
            </section>
        </div>
    </div>

    <style>
    .archived-item {
        border-left: 3px solid #f59e0b;
        background: rgba(245, 158, 11, 0.05);
    }

    .archived-badge {
        display: block;
        color: #f59e0b;
        font-size: 11px;
        margin-top: 4px;
        font-weight: 600;
    }

    .dependent-tag {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
        font-weight: 600;
    }

    .search-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border-light);
        border-radius: 6px;
        margin-bottom: 12px;
        font-size: 14px;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary);
    }
    </style>

    <script>
        function loadArchivedPatient(patientId, patientType) {
            const details = document.getElementById('patientDetails');
            details.innerHTML = '<p class="muted">Loading archived patient...</p>';

            const url = `/ajax/archived-patient/${patientId}/?type=${patientType}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    details.innerHTML = data.html;

                    // Highlight active patient
                    document.querySelectorAll('.patient-item').forEach(el => el.classList.remove('active'));
                    const activeItem = document.querySelector(`[data-patient-id="${patientId}"][data-patient-type="${patientType}"]`);
                    if (activeItem) activeItem.classList.add('active');
                })
                .catch(err => {
                    console.error('Failed to load archived patient details:', err);
                    details.innerHTML = `<p class="muted">Failed to load patient details.</p>`;
                });
        }

        // Load first patient on page load
        document.addEventListener('DOMContentLoaded', () => {
            const firstPatient = document.querySelector('.patient-item');
            if (firstPatient) {
                const patientId = firstPatient.dataset.patientId;
                const patientType = firstPatient.dataset.patientType;
                loadArchivedPatient(patientId, patientType);
            }
        });

        // Search functionality
        const searchInput = document.getElementById('patientSearch');
        searchInput.addEventListener('input', function () {
            const query = this.value.toLowerCase().trim();
            const patients = document.querySelectorAll('.patient-item');
            
            patients.forEach(item => {
                const name = item.querySelector('strong')?.innerText.toLowerCase() || '';
                const meta = item.querySelector('small')?.innerText.toLowerCase() || '';
                
                if (name.includes(query) || meta.includes(query)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    </script>
{% endif %}
{% endblock %}