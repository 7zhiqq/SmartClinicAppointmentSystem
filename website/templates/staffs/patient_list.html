{% extends "components/base.html" %}
{% load custom_filters %}
{% load static %}

{% block content %}
    <link rel="stylesheet" href="{% static 'css/medrecords.css' %}">
    <link rel="stylesheet" href="{% static 'css/schedule.css' %}">

    {% if user.is_authenticated %}
            {% include "components/sidebar/staff.html" %}
            <div class="main-content">
                <div class="schedule-header mb-4">
                    <div>
                        <h2 class="heading-title">Patients</h2>
                        <p class="subtitle"> View and manage patient medical records</p>
                    </div>
                    <a href="{% url 'archived_patients' %}" class="archived-btn mt-2">
                        <i class="bi bi-archive"></i> Archived Patients
                    </a>
                </div>
                <div class="dashboard">
                    <aside class="patient-list-panel">
                        <input
                            type="text"
                            id="patientSearch"
                            class="search-input"
                            placeholder="Search patients..."
                        >   


                        <ul class="patient-list">
                            {% for patient in patients %}
                                <li class="patient-item" data-patient-id="{{ patient.pk }}" onclick="loadPatient('{{ patient.pk }}')">
                                    <div class="avatar">
                                        {% if patient.user %}
                                            {{ patient.user.first_name|default:"X"|slice:":1" }}{{ patient.user.last_name|default:"X"|slice:":1" }}
                                        {% else %}
                                            {{ patient.first_name|default:"X"|slice:":1" }}{{ patient.last_name|default:"X"|slice:":1" }}
                                        {% endif %}
                                    </div>
                                    <div>
                                        <strong>
                                            {% if patient.user %}
                                                {{ patient.user.first_name|default:"N/A" }} {{ patient.user.last_name|default:"" }}
                                            {% else %}
                                                {{ patient.first_name|default:"N/A" }} {{ patient.last_name|default:"" }}
                                            {% endif %}
                                        </strong>
                                        <small>{{ patient.age|default:"N/A" }} yrs â€¢ {{ patient.gender|gender_full|default:"N/A" }}
                                        </small>
                                    </div>
                                </li>
                            {% empty %}
                                <li><p class="muted">No patients available.</p></li>
                            {% endfor %}
                        </ul>
                    </aside>

                    <section class="patient-details" id="patientDetails">
                        <p class="muted">Select a patient to view details...</p>
                    </section>
                </div> 
            </div>

            <script>
                function loadPatient(patientId) {
                    const details = document.getElementById('patientDetails');
                    details.innerHTML = '<p class="muted">Loading patient...</p>';

                    const url = `/ajax/patient/${patientId}/`;
                    console.log('Fetching patient details:', url);

                    fetch(url)
                        .then(response => {
                            console.log('AJAX status:', response.status);
                            if (!response.ok) throw new Error('Network response not ok');
                            return response.json();
                        })
                        .then(data => {
                            console.log('AJAX response data:', data);
                            details.innerHTML = data.html;

                            // Highlight active patient
                            document.querySelectorAll('.patient-item').forEach(el => el.classList.remove('active'));
                            const activeItem = document.querySelector(`[data-patient-id="${patientId}"]`);
                            if (activeItem) activeItem.classList.add('active');
                        })
                        .catch(err => {
                            console.error('Failed to load patient details:', err);
                            details.innerHTML = `<p class="muted">Failed to load patient details. ${err.message}</p>`;
                        });
                }

                // Load first patient on page load
                document.addEventListener('DOMContentLoaded', () => {
                    const firstPatient = document.querySelector('.patient-item');
                    if (firstPatient) loadPatient(firstPatient.dataset.patientId);
                });

                const searchInput = document.getElementById('patientSearch');

                searchInput.addEventListener('input', function () {
                    const query = this.value.toLowerCase().trim();
                    const patients = document.querySelectorAll('.patient-item');
                    patients.forEach(item => {
                        const name = item.querySelector('strong')?.innerText.toLowerCase() || '';
                        const meta = item.querySelector('small')?.innerText.toLowerCase() || '';
                        // Match name, age, or gender
                        if (name.includes(query) || meta.includes(query)) {
                            item.style.display = 'flex';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });

            </script>
    {% endif %}
{% endblock %}
