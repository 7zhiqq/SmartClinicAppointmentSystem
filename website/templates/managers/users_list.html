{% extends 'components/base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/users.css' %}">
<link rel="stylesheet" href="{% static 'css/appointments.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/bootstrap-icons.min.css">

{% if user.is_authenticated and user.role == "manager" %}
{% include 'components/sidebar/manager.html' %}

<div class="main-content">

    <!-- Header -->
    <div class="users-header">
        <div>
            <h2 class="heading-title">
                <i class="bi bi-people"></i> User Management
            </h2>
            <p class="subtitle">Manage doctors, staff, and managers</p>
        </div>

        <div class="d-flex gap-2">
            <a href="{% url 'create_invite' %}" class="btn btn-primary">
                <i class="bi bi-person-add"></i> Invite Users
            </a>
            <a href="{% url 'manager_add_specialization' %}" class="btn btn-primary">
                + Doctor Dept
            </a>
        </div>
    </div>

    <!-- Statistics Cards (UNCHANGED) -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="stat-card total">
                <div class="stat-number">{{ total_doctors }}</div>
                <div class="stat-label">Doctors</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card confirmed">
                <div class="stat-number">{{ total_staff }}</div>
                <div class="stat-label">Staff</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card pending">
                <div class="stat-number">{{ total_managers }}</div>
                <div class="stat-label">Managers</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card completed">
                <div class="stat-number">{{ user_list|length }}</div>
                <div class="stat-label">Total Users</div>
            </div>
        </div>
    </div>

    <!-- Search & Filters (Appointments-style) -->
    <div class="d-flex gap-2 mb-4">
        <div class="search-box flex-grow-1">
            <i class="fas fa-search"></i>
            <input
                type="text"
                id="searchInput"
                class="form-control border-0"
                placeholder="Search by name, email, or username..."
            >
        </div>

        <!-- Role Filter -->
        <div class="dropdown">
            <button class="dropdown-toggle" id="roleFilterBtn">
                All Roles
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item active" data-value="">All Roles</a></li>
                <li><a class="dropdown-item" data-value="doctor">Doctor</a></li>
                <li><a class="dropdown-item" data-value="staff">Staff</a></li>
                <li><a class="dropdown-item" data-value="manager">Manager</a></li>
            </ul>
        </div>

        <!-- Status Filter -->
        <div class="dropdown">
            <button class="dropdown-toggle" id="statusFilterBtn">
                All Status
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item active" data-value="">All Status</a></li>
                <li><a class="dropdown-item" data-value="approved">Approved</a></li>
                <li><a class="dropdown-item" data-value="pending">Pending</a></li>
                <li><a class="dropdown-item" data-value="rejected">Rejected</a></li>
                <li><a class="dropdown-item" data-value="deactivated">Deactivated</a></li>
            </ul>
        </div>
    </div>

    <!-- USERS TABLE (100% UNCHANGED CONTENT) -->
    <div class="users-table-wrapper">
        <table class="users-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Role</th>
                    <th>Additional Info</th>
                    <th>Status</th>
                    <th style="text-align:right;">Actions</th>
                </tr>
            </thead>

            <tbody>
            {% for item in user_list %}
                <tr class="user-row"
                    data-name="{{ item.user.get_full_name|lower }}"
                    data-username="{{ item.user.username|lower }}"
                    data-email="{{ item.user.email|lower }}"
                    data-role="{{ item.user.role }}"
                    data-status="{% if not item.user.is_active %}deactivated{% else %}{{ item.status }}{% endif %}">

                    <td>
                        <div class="user-cell">
                            <div class="user-avatar">
                                {% if item.user.role == 'doctor' and item.profile and item.profile.profile_picture %}
                                    <img src="{{ item.profile.profile_picture.url }}" alt="Profile picture">
                                {% else %}
                                    <span class="avatar-fallback">
                                        {{ item.user.first_name|slice:":1" }}{{ item.user.last_name|slice:":1" }}
                                    </span>
                                {% endif %}
                            </div>

                            <div>
                                <strong>{{ item.user.get_full_name|default:item.user.username }}</strong><br>
                                <small class="text-muted">{{ item.user.email }}</small>
                            </div>
                        </div>
                    </td>

                    <td>
                        <span class="badge-users bg-primary text-uppercase">
                            {{ item.user.role }}
                        </span>
                    </td>

                    <td>
                        {% if item.user.role == 'doctor' and item.additional_info.specialization %}
                            <span class="badge-users bg-info">
                                {{ item.additional_info.specialization }}
                            </span><br>
                            <small class="text-muted">
                                License: {{ item.additional_info.license }}
                            </small>
                        {% elif item.user.role == 'staff' and item.additional_info.staff_id %}
                            <small class="text-muted">
                                ID: {{ item.additional_info.staff_id }}
                            </small>
                        {% elif item.user.role == 'manager' and item.additional_info.manager_id %}
                            <small class="text-muted">
                                ID: {{ item.additional_info.manager_id }}
                            </small>
                        {% else %}
                            <span class="text-muted">â€”</span>
                        {% endif %}
                    </td>

                    <td>
                        {% if not item.user.is_active %}
                            <span class="status rejected">Deactivated</span>
                        {% elif item.status == 'approved' %}
                            <span class="status approved">Approved</span>
                        {% elif item.status == 'pending' %}
                            <span class="status pending">Pending</span>
                        {% elif item.status == 'rejected' %}
                            <span class="status rejected">Rejected</span>
                        {% else %}
                            <span class="status approved">Active</span>
                        {% endif %}
                    </td>

                    <td style="text-align:right;">
                        <div class="action-buttons">

                            <a href="{% url 'manager_user_details' item.user.id %}"
                               class="action-btn action-view"
                               title="View Details">
                                <i class="bi bi-eye"></i>
                            </a>

                            {% if item.user.role == 'doctor' and item.status == 'pending' %}
                                <a href="{% url 'manager_approve_doctor' item.profile.id %}"
                                   class="action-btn action-approve"
                                   title="Approve">
                                    <i class="bi bi-check-lg"></i>
                                </a>
                                <a href="{% url 'manager_reject_doctor' item.profile.id %}"
                                   class="action-btn action-reject"
                                   title="Reject">
                                    <i class="bi bi-x-lg"></i>
                                </a>
                            {% endif %}

                            {% if item.user != user %}
                                {% if item.user.is_active %}
                                    <a href="{% url 'manager_deactivate_user' item.user.id %}"
                                       class="action-btn action-reject"
                                       title="Deactivate"
                                       onclick="return confirm('Deactivate this user?')">
                                        <i class="bi bi-person-x"></i>
                                    </a>
                                {% else %}
                                    <a href="{% url 'manager_activate_user' item.user.id %}"
                                       class="action-btn action-approve"
                                       title="Activate">
                                        <i class="bi bi-person-check"></i>
                                    </a>
                                {% endif %}

                                <a href="{% url 'manager_change_user_role' item.user.id %}"
                                   class="action-btn action-edit"
                                   title="Change Role">
                                    <i class="bi bi-arrow-left-right"></i>
                                </a>
                            {% endif %}

                        </div>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="5" class="users-empty">
                        No users found.
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Search & Filter JS (Appointments-style) -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("searchInput");
    const rows = document.querySelectorAll(".user-row");

    let roleFilter = "";
    let statusFilter = "";

    function filterTable() {
        const search = searchInput.value.toLowerCase().trim();

        rows.forEach(row => {
            const text =
                row.dataset.name +
                row.dataset.username +
                row.dataset.email;

            const role = row.dataset.role;
            const status = row.dataset.status;

            const matchSearch = !search || text.includes(search);
            const matchRole = !roleFilter || role === roleFilter;
            const matchStatus = !statusFilter || status === statusFilter;

            row.style.display =
                (matchSearch && matchRole && matchStatus) ? "" : "none";
        });
    }

    searchInput.addEventListener("input", filterTable);

    document.querySelectorAll(".dropdown").forEach(dropdown => {
        const btn = dropdown.querySelector(".dropdown-toggle");
        const items = dropdown.querySelectorAll(".dropdown-item");

        btn.addEventListener("click", e => {
            e.stopPropagation();
            dropdown.querySelector(".dropdown-menu").classList.toggle("show");
        });

        items.forEach(item => {
            item.addEventListener("click", e => {
                e.preventDefault();
                e.stopPropagation();

                items.forEach(i => i.classList.remove("active"));
                item.classList.add("active");

                btn.textContent = item.textContent;

                if (btn.id === "roleFilterBtn") roleFilter = item.dataset.value;
                if (btn.id === "statusFilterBtn") statusFilter = item.dataset.value;

                dropdown.querySelector(".dropdown-menu").classList.remove("show");
                filterTable();
            });
        });
    });

    document.addEventListener("click", () => {
        document
            .querySelectorAll(".dropdown-menu")
            .forEach(menu => menu.classList.remove("show"));
    });
});
</script>

{% endif %}
{% endblock %}
