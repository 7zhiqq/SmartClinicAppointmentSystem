{% extends "components/base.html" %}
{% load static %}

{% block content %}
    <link rel="stylesheet" href="{% static 'css/users.css' %}">
    <link rel="stylesheet" href="{% static 'css/user-details.css' %}">
    
    {% if user.is_authenticated and user.role == "manager" %}
        {% include 'components/sidebar/manager.html' %}
        
        <div class="main-content">
            <!-- Header -->
            <div class="users-header">
                <div>
                    <h2 class="heading-title">
                        <i class="bi bi-person-circle"></i>
                        User Details
                    </h2>
                    <p class="subtitle">
                        View detailed information about {{ viewed_user.get_full_name|default:viewed_user.username }}
                    </p>
                </div>

                <a href="{% url 'manager_users_list' %}" class="btn btn-primary">
                    <i class="bi bi-arrow-left"></i>
                    Back to Users
                </a>
            </div>

            <!-- User Header Card -->
            <div class="user-detail-header-card">
                <div class="user-header-content">
                    <div class="user-detail-avatar">
                        {% if viewed_user.role == 'doctor' and profile and profile.profile_picture %}
                            <img src="{{ profile.profile_picture.url }}" alt="Profile">
                        {% else %}
                            <span class="avatar-fallback-large">
                                {{ viewed_user.first_name|slice:":1" }}{{ viewed_user.last_name|slice:":1" }}
                            </span>
                        {% endif %}
                    </div>
                    
                    <div class="user-detail-info">
                        <h3>{{ viewed_user.get_full_name|default:viewed_user.username }}</h3>
                        <div class="user-detail-meta">
                            <span class="badge-users bg-primary text-uppercas">{{ viewed_user.role }}</span>
                            {% if not viewed_user.is_active %}
                                <span class="badge bg-danger">
                                    <i class="bi bi-person-x"></i> Deactivated
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="details-grid">
                <!-- Account Information -->
                <div class="detail-card">
                    <div class="detail-card-header">
                        <h4>
                            <i class="bi bi-person-badge"></i>
                            Account Information
                        </h4>
                    </div>
                    <div class="detail-card-content">
                        <div class="info-item">
                            <span class="info-label">Username</span>
                            <span class="info-value">{{ viewed_user.username }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Email</span>
                            <span class="info-value">{{ viewed_user.email }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Full Name</span>
                            <span class="info-value">{{ viewed_user.get_full_name|default:"Not provided" }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Date Joined</span>
                            <span class="info-value">{{ viewed_user.date_joined|date:"F d, Y" }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Account Status</span>
                            <span class="info-value">
                                {% if viewed_user.is_active %}
                                    <span class="status approved">
                                        <i class="bi bi-check-circle-fill"></i> Active
                                    </span>
                                {% else %}
                                    <span class="status rejected">
                                        <i class="bi bi-x-circle-fill"></i> Deactivated
                                    </span>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Role-Specific Information -->
                {% if viewed_user.role == 'doctor' and profile %}
                <div class="detail-card">
                    <div class="detail-card-header">
                        <h4>
                            <i class="bi bi-briefcase"></i>
                            Doctor Information
                        </h4>
                    </div>
                    <div class="detail-card-content">
                        <div class="info-item">
                            <span class="info-label">Specialization</span>
                            <span class="info-value">
                                {% if additional_data.specialization %}
                                    <span class="badge-users bg-info text-uppercas">{{ additional_data.specialization }}</span>
                                {% else %}
                                    <span class="text-muted">Not specified</span>
                                {% endif %}
                            </span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">License Number</span>
                            <span class="info-value">
                                <code>{{ additional_data.license_number }}</code>
                            </span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Years of Experience</span>
                            <span class="info-value">{{ additional_data.years_experience }} years</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Approval Status</span>
                            <span class="info-value">
                                {% if additional_data.is_approved %}
                                    <span class="status approved">
                                        <i class="bi bi-check-circle-fill"></i> Approved
                                    </span>
                                    {% if additional_data.approved_at %}
                                        <small class="text-muted">on {{ additional_data.approved_at|date:"M d, Y" }}</small>
                                    {% endif %}
                                {% elif additional_data.is_rejected %}
                                    <span class="status rejected">
                                        <i class="bi bi-x-circle-fill"></i> Rejected
                                    </span>
                                {% else %}
                                    <span class="status pending">
                                        <i class="bi bi-clock-fill"></i> Pending
                                    </span>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    
                    {% if additional_data.bio %}
                    <div class="detail-card-section">
                        <h5><i class="bi bi-file-text"></i> Biography</h5>
                        <p class="bio-text">{{ additional_data.bio }}</p>
                    </div>
                    {% endif %}
                    
                    {% if additional_data.qualifications %}
                    <div class="detail-card-section">
                        <h5><i class="bi bi-award"></i> Qualifications</h5>
                        <p class="bio-text">{{ additional_data.qualifications }}</p>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Recent Activity -->
                <div class="detail-card full-width">
                    <div class="detail-card-header">
                        <h4>
                            <i class="bi bi-clock-history"></i>
                            Recent Activity
                        </h4>
                    </div>
                    <div class="detail-card-content">
                        {% if recent_activities %}
                        <div class="activity-timeline">
                            {% for activity in recent_activities %}
                            <div class="activity-item-timeline">
                                <div class="activity-icon-circle">
                                    {% if activity.action_type == 'create' %}
                                        <i class="bi bi-plus-circle"></i>
                                    {% elif activity.action_type == 'update' %}
                                        <i class="bi bi-pencil"></i>
                                    {% elif activity.action_type == 'delete' %}
                                        <i class="bi bi-trash"></i>
                                    {% else %}
                                        <i class="bi bi-circle"></i>
                                    {% endif %}
                                </div>
                                <div class="activity-content-timeline">
                                    <div class="activity-action">
                                        <strong>{{ activity.action_type|title }}</strong> 
                                        {{ activity.model_name }}
                                        {% if activity.related_object_repr %}
                                            - {{ activity.related_object_repr }}
                                        {% endif %}
                                    </div>
                                    <div class="activity-time">
                                        <i class="bi bi-clock"></i>
                                        {{ activity.timestamp|date:"M d, Y h:i A" }}
                                    </div>
                                    {% if activity.description %}
                                    <div class="activity-description">
                                        {{ activity.description }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="empty-state-text">
                            <i class="bi bi-inbox"></i>
                            <p>No recent activity</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Account Management -->
                {% if viewed_user != user %}
                <div class="detail-card full-width">
                    <div class="detail-card-header">
                        <h4>
                            <i class="bi bi-gear"></i>
                            Account Management
                        </h4>
                    </div>
                    <div class="detail-card-content">
                        <div class="action-buttons-grid">
                            {% if viewed_user.role == 'doctor' and profile %}
                                {% if not profile.is_approved and not profile.is_rejected %}
                                    <a href="{% url 'manager_approve_doctor' profile.id %}" 
                                       class="action-btn action-approve">
                                        <i class="bi bi-check-lg"></i> Approve Doctor
                                    </a>
                                    <a href="{% url 'manager_reject_doctor' profile.id %}" 
                                       class="action-btn action-reject">
                                        <i class="bi bi-x-lg"></i> Reject Doctor
                                    </a>
                                {% endif %}
                            {% endif %}

                            <a href="{% url 'manager_change_user_role' viewed_user.id %}" 
                               class="action-btn action-edit">
                                <i class="bi bi-arrow-left-right"></i> Change Role
                            </a>

                            {% if viewed_user.is_active %}
                                <a href="{% url 'manager_deactivate_user' viewed_user.id %}" 
                                   class="action-btn action-deactivate">
                                    <i class="bi bi-person-x"></i> Deactivate Account
                                </a>
                            {% else %}
                                <a href="{% url 'manager_activate_user' viewed_user.id %}" 
                                   class="action-btn action-activate">
                                    <i class="bi bi-person-check"></i> Activate Account
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    {% endif %}
{% endblock %}