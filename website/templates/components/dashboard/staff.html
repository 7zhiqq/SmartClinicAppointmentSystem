{% load static %}
<link rel="stylesheet" href="{% static 'css/doctor-dashboard.css' %}">

<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        <div class="header-content">
            <div>
                <h2 class="heading-title">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </h2>
                <p class="subtitle">Welcome back, {{ user.get_full_name }}!</p>
            </div>
            <div class="user-info">
                <span class="date-display">{% now "l, M d" %}</span>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card appointments">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="bi bi-calendar-check"></i>
                </div>
            </div>
            <div class="stat-number">{{ today_appointments_count|default:0 }}</div>
            <div class="stat-label">Today's Appointments</div>
            <div class="stat-meta">{{ total_appointments|default:0 }} total appointments</div>
        </div>

        <div class="stat-card patients">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="bi bi-people"></i>
                </div>
            </div>
            <div class="stat-number">{{ total_patients|default:0 }}</div>
            <div class="stat-label">Total Patients</div>
            <div class="stat-meta">{{ pending_appointments|default:0 }} pending approvals</div>
        </div>

        <div class="stat-card completed">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="bi bi-check-circle"></i>
                </div>
            </div>
            <div class="stat-number">{{ completed_appointments|default:0 }}</div>
            <div class="stat-label">Completed</div>
            <div class="stat-meta">This month</div>
        </div>

        <div class="stat-card rating">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="bi bi-person-badge"></i>
                </div>
            </div>
            <div class="stat-number">{{ active_doctors|default:0 }}</div>
            <div class="stat-label">Active Doctors</div>
            <div class="stat-meta">{{ confirmed_appointments|default:0 }} confirmed today</div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-grid">
        <!-- Left Column -->
        <div>
            <!-- Today's Schedule -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-calendar-event"></i>
                        Today's Schedule
                    </h3>
                    <a href="{% url 'staff_calendar' %}" class="btn btn-primary">
                        <i class="bi bi-calendar3"></i>
                        View Calendar
                    </a>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    {% if today_appointments %}
                        {% for appointment in today_appointments %}
                            <div class="appointment-item">
                                <div class="appointment-header">
                                    <div class="patient-name">
                                        {% if appointment.appointment_type == "self" %}
                                            {{ appointment.patient.get_full_name }}
                                        {% else %}
                                            {{ appointment.dependent_patient.full_name }}
                                        {% endif %}
                                    </div>
                                    <span class="appointment-badge badge-{{ appointment.status }}">
                                        {% if appointment.status == 'pending' %}
                                            Pending
                                        {% elif appointment.status == 'approved' %}
                                            Confirmed
                                        {% elif appointment.status == 'completed' %}
                                            Completed
                                        {% else %}
                                            {{ appointment.status|title }}
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="appointment-time">
                                    <i class="bi bi-clock"></i>
                                    <span>{{ appointment.start_time|date:"h:i A" }} - {{ appointment.end_time|date:"h:i A" }}</span>
                                </div>
                                <div class="appointment-time">
                                    <i class="bi bi-person-badge"></i>
                                    <span>Dr. {{ appointment.doctor.user.get_full_name }}</span>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="bi bi-calendar-x"></i>
                            <p>No appointments scheduled for today</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Pending Appointments -->
            <div class="card" style="margin-top: 1.5rem;">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-clock-history"></i>
                        Pending Approvals
                        <span class="badge-count">{{ pending_appointments|default:0 }}</span>
                    </h3>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    {% if pending_appointments_list %}
                        {% for appointment in pending_appointments_list %}
                            <div class="pending-item">
                                <div class="pending-info">
                                    <div class="patient-name">
                                        {% if appointment.appointment_type == "self" %}
                                            {{ appointment.patient.get_full_name }}
                                        {% else %}
                                            {{ appointment.dependent_patient.full_name }}
                                        {% endif %}
                                        {% if appointment.appointment_type == "dependent" %}
                                            <span class="badge" style="font-size: 0.75rem; background: #6366f1; color: white; padding: 2px 6px; border-radius: 4px; margin-left: 6px;">Dependent</span>
                                        {% endif %}
                                    </div>
                                    <div class="pending-time">
                                        {{ appointment.start_time|date:"M d, Y â€¢ h:i A" }}
                                    </div>
                                    <div class="pending-time" style="color: #6b7280; font-size: 0.85rem;">
                                        <i class="bi bi-person-badge"></i>
                                        Dr. {{ appointment.doctor.user.get_full_name }}
                                    </div>
                                </div>
                                <div class="pending-actions">
                                    <button class="btn-mini btn-approve" 
                                            data-id="{{ appointment.id }}" 
                                            data-type="{{ appointment.appointment_type }}" 
                                            title="Approve"
                                            onclick="updateAppointmentStatus({{ appointment.id }}, '{{ appointment.appointment_type }}', 'approve')">
                                        <i class="bi bi-check-lg"></i>
                                    </button>
                                    <button class="btn-mini btn-reject" 
                                            data-id="{{ appointment.id }}" 
                                            data-type="{{ appointment.appointment_type }}" 
                                            title="Reject"
                                            onclick="updateAppointmentStatus({{ appointment.id }}, '{{ appointment.appointment_type }}', 'reject')">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="bi bi-check-circle"></i>
                            <p>No pending approvals</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div>
            <!-- Upcoming Appointments -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-calendar-week"></i>
                        Upcoming Appointments
                    </h3>
                </div>
                <div class="card-body" style="max-height: 612px; overflow-y: auto;">
                    {% if upcoming_appointments %}
                        {% for appointment in upcoming_appointments %}
                            <div class="appointment-item">
                                <div class="appointment-header">
                                    <div class="patient-name">
                                        {% if appointment.appointment_type == "self" %}
                                            {{ appointment.patient.get_full_name }}
                                        {% else %}
                                            {{ appointment.dependent_patient.full_name }}
                                        {% endif %}
                                    </div>
                                    <span class="appointment-badge badge-{{ appointment.status }}">
                                        {% if appointment.status == 'pending' %}
                                            Pending
                                        {% elif appointment.status == 'approved' %}
                                            Confirmed
                                        {% elif appointment.status == 'completed' %}
                                            Completed
                                        {% else %}
                                            {{ appointment.status|title }}
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="appointment-time">
                                    <i class="bi bi-calendar"></i>
                                    <span>{{ appointment.start_time|date:"M d, Y" }}</span>
                                </div>
                                <div class="appointment-time">
                                    <i class="bi bi-clock"></i>
                                    <span>{{ appointment.start_time|date:"h:i A" }} - {{ appointment.end_time|date:"h:i A" }}</span>
                                </div>
                                <div class="appointment-time">
                                    <i class="bi bi-person-badge"></i>
                                    <span>Dr. {{ appointment.doctor.user.get_full_name }}</span>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="bi bi-calendar-plus"></i>
                            <p>No upcoming appointments</p>
                        </div>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>
</div>

<meta name="csrf-token" content="{{ csrf_token }}">

<script>
function updateAppointmentStatus(appointmentId, appointmentType, action) {
    console.log('Updating appointment:', {appointmentId, appointmentType, action});
    
    const csrftoken = document.querySelector('meta[name="csrf-token"]').content;
    const formData = new FormData();
    formData.append('appointment_type', appointmentType);

    fetch(`/appointments/${appointmentId}/update_status/${action}/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": csrftoken,
        },
        body: formData
    })
    .then(res => {
        if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
    })
    .then(data => {
        if(data.error) {
            alert(data.error);
        } else {
            console.log('Success:', data);
            location.reload();
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('An error occurred while updating the appointment: ' + err.message);
    });
}
</script>